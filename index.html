<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Secure Access Terminal</title>
	<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg-color: #050a10;
			--panel-bg: rgba(10, 20, 35, 0.85);
			--cyan: #00f3ff;
			--purple: #bc13fe;
			--green: #0aff0a;
			--danger: #ff0033;
			--text-main: #cceeff;
			--text-muted: #5f7d8c;
		}

		* { box-sizing: border-box; }

		body {
			background-color: var(--bg-color);
			background-image: 
				linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
				linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
			background-size: 40px 40px;
			color: var(--text-main);
			font-family: 'Rajdhani', sans-serif;
			margin: 0;
			padding: 24px;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			overflow-x: hidden;
		}

		/* CRT Scanline Overlay */
		body::after {
			content: " ";
			display: block;
			position: fixed;
			top: 0; left: 0; bottom: 0; right: 0;
			background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
			background-size: 100% 4px;
			z-index: 999;
			pointer-events: none;
		}

		.container {
			width: 100%;
			max-width: 480px;
			position: relative;
			z-index: 10;
		}

		/* Panel Styles */
		.panel {
			background: var(--panel-bg);
			border: 1px solid rgba(0, 243, 255, 0.3);
			padding: 30px;
			position: relative;
			box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(5px);
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		/* Tech Decoration Corner */
		.panel::after {
			content: '';
			position: absolute;
			top: -1px; right: -1px;
			border-top: 20px solid var(--cyan);
			border-left: 20px solid transparent;
			opacity: 0.8;
		}
		.panel::before {
			content: '';
			position: absolute;
			bottom: -1px; left: -1px;
			border-bottom: 20px solid var(--purple);
			border-right: 20px solid transparent;
			opacity: 0.8;
		}

		h2 {
			font-family: 'Share Tech Mono', monospace;
			font-size: 28px;
			margin: 0;
			text-transform: uppercase;
			text-align: center;
			color: #fff;
			text-shadow: 0 0 10px var(--cyan);
			letter-spacing: 2px;
		}

		p.status {
			text-align: center;
			font-family: 'Share Tech Mono', monospace;
			font-size: 14px;
			color: var(--cyan);
			opacity: 0.8;
			margin: 0;
		}

		/* Inputs */
		input {
			width: 100%;
			background: rgba(0, 0, 0, 0.4);
			border: 1px solid #334;
			color: var(--cyan);
			font-family: 'Share Tech Mono', monospace;
			font-size: 16px;
			padding: 15px;
			outline: none;
			transition: all 0.3s;
			margin-bottom: 15px;
			display: block;
		}
		
		input:focus {
			border-color: var(--cyan);
			box-shadow: 0 0 15px rgba(0, 243, 255, 0.2) inset;
		}

		input::placeholder {
			color: rgba(95, 125, 140, 0.6);
		}

		/* Buttons */
		button {
			width: 100%;
			background: transparent;
			border: 1px solid var(--cyan);
			color: var(--cyan);
			padding: 15px;
			font-family: 'Share Tech Mono', monospace;
			font-size: 16px;
			text-transform: uppercase;
			cursor: pointer;
			transition: 0.2s;
			position: relative;
			overflow: hidden;
			margin-bottom: 10px;
			font-weight: bold;
			letter-spacing: 1px;
		}

		button:hover {
			background: var(--cyan);
			color: #000;
			box-shadow: 0 0 20px var(--cyan);
		}
		
		button.primary {
			background: rgba(0, 243, 255, 0.1);
			border-width: 2px;
		}
		
		button.ghost {
			border-color: var(--text-muted);
			color: var(--text-muted);
		}
		button.ghost:hover {
			border-color: #fff;
			color: #fff;
			background: rgba(255,255,255,0.1);
			box-shadow: none;
		}

		button.danger {
			border-color: var(--danger);
			color: var(--danger);
		}
		button.danger:hover {
			background: var(--danger);
			color: #fff;
			box-shadow: 0 0 20px var(--danger);
		}

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			pointer-events: none;
		}

		/* Utilities */
		.hidden { display: none !important; }
		
		.error-box {
			color: var(--danger);
			font-size: 13px;
			padding: 10px;
			background: rgba(255, 0, 50, 0.1);
			border: 1px solid var(--danger);
			text-align: center;
			font-family: 'Share Tech Mono', monospace;
			margin-top: 10px;
		}

		.success-text {
			color: var(--green);
			text-align: center;
			margin-bottom: 10px;
			font-size: 18px;
			text-shadow: 0 0 5px var(--green);
		}

		.info-row {
			display: flex;
			justify-content: space-between;
			border-bottom: 1px solid rgba(255,255,255,0.1);
			padding: 8px 0;
			font-size: 14px;
		}
		.info-label { color: var(--text-muted); }
		.info-val { color: #fff; font-family: 'Share Tech Mono', monospace; }

		a.app-link {
			display: block;
			text-align: center;
			background: rgba(10, 255, 10, 0.1);
			border: 1px solid var(--green);
			color: var(--green);
			padding: 15px;
			text-decoration: none;
			font-family: 'Share Tech Mono', monospace;
			text-transform: uppercase;
			font-weight: bold;
			transition: 0.3s;
			margin: 10px 0;
		}
		a.app-link:hover {
			background: var(--green);
			color: #000;
			box-shadow: 0 0 15px var(--green);
		}

		/* Spinner */
		.loading-ring {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 2px solid transparent;
			border-top: 2px solid currentColor;
			border-right: 2px solid currentColor;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}
		@keyframes spin { 100% { transform: rotate(360deg); } }

	</style>
</head>
<body>

	<div class="container" id="authContainer">
		<div class="panel">
			
			<h2>SECURE ACCESS</h2>
			<p class="status" id="statusMessage">INITIALIZING PROTOCOLS...</p>

			<!-- AUTH FORM (Initial View) -->
			<div id="authForm" class="hidden">
				<input type="email" id="emailInput" placeholder="OPERATOR ID [EMAIL]" autocomplete="email">
				<input type="password" id="passwordInput" placeholder="ACCESS CODE [PASSWORD]" autocomplete="current-password">
				
				<div style="margin-top: 20px;">
					<button id="loginBtn" class="primary">
						<span id="loginText">AUTHENTICATE</span>
						<div id="loginSpinner" class="loading-ring hidden"></div>
					</button>
					
					<button id="getKeyBtn" class="ghost">
						REQUEST ACCESS KEY
					</button>
				</div>

				<div id="errorBox" class="error-box hidden"></div>
			</div>

			<!-- DASHBOARD (Authenticated View) -->
			<div id="dashboard" class="hidden">
				<div class="success-text">IDENTITY VERIFIED</div>
				
				<div style="margin-bottom: 20px;">
					<div class="info-row">
						<span class="info-label">UID:</span>
						<span class="info-val" id="userIdDisplay">--</span>
					</div>
					<div class="info-row">
						<span class="info-label">USER:</span>
						<span class="info-val" id="userEmailDisplay">--</span>
					</div>
				</div>
				
				<!-- Link to Main App -->
				<a href="app.html" class="app-link">
					>> INITIALIZE PREDICTOR <<
				</a>
				
				<button id="logoutBtn" class="danger">
					TERMINATE SESSION
				</button>
			</div>

		</div>
	</div>

	<script type="module">
		// --- Firebase SDK Imports (v11.6.1 for stability) ---
		import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
		import { 
			getAuth, 
			signInAnonymously, 
			signInWithCustomToken, 
			onAuthStateChanged,
			signInWithEmailAndPassword,
			signOut
		} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
		
		// --- Firebase Configuration (Updated for Aviator Time) ---
		const firebaseConfig = {
			apiKey: "AcbXX3KgvqD7B8Y4WjCu6yNx1Prfu5cNHz",
			authDomain: "aviator-time-54227.firebaseapp.com",
			projectId: "aviator-time-54227",
			storageBucket: "aviator-time-54227.firebasestorage.app",
			messagingSenderId: "898262142598",
			appId: "1:898262142598:web:67faa0b1dd6676c75bcb07",
			measurementId: "G-SFT4PP0NJX"
		};
		
		// --- DOM Elements ---
		const authForm = document.getElementById('authForm');
		const dashboard = document.getElementById('dashboard');
		const emailInput = document.getElementById('emailInput');
		const passwordInput = document.getElementById('passwordInput');
		const loginBtn = document.getElementById('loginBtn');
		const getKeyBtn = document.getElementById('getKeyBtn');
		const logoutBtn = document.getElementById('logoutBtn');
		const statusMessage = document.getElementById('statusMessage');
		const errorBox = document.getElementById('errorBox');
		const userIdDisplay = document.getElementById('userIdDisplay');
		const userEmailDisplay = document.getElementById('userEmailDisplay');

		// Spinners and text elements
		const loginSpinner = document.getElementById('loginSpinner');
		const loginText = document.getElementById('loginText');

		let auth;

		// --- Firebase Initialization ---
		function initializeFirebase() {
			try {
				const app = initializeApp(firebaseConfig);
				auth = getAuth(app);
				
				// Set up initial authentication using custom token or anonymously
				// Note: Anonymous Auth must be enabled in Firebase Console for this fallback to work
				if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
					signInWithCustomToken(auth, __initial_auth_token)
						.catch(e => {
							console.error("Custom token sign in failed, attempting anonymous. Error:", e);
							signInAnonymously(auth);
						});
				} else {
					// Fallback to anonymous to show the UI state
					signInAnonymously(auth).catch(e => console.log("Anonymous auth not enabled or failed", e));
				}

				statusMessage.textContent = "AWAITING CREDENTIALS...";

				// Set up Authentication State Listener
				onAuthStateChanged(auth, (user) => {
					updateUI(user);
				});

			} catch (error) {
				console.error("Firebase Initialization Error:", error);
				statusMessage.textContent = `SYSTEM FAILURE: ${error.message}`;
				authForm.classList.remove('hidden');
			}
		}

		// --- UI Logic ---
		function updateUI(user) {
			errorBox.classList.add('hidden');
			
			if (user && user.email) {
				// Logged In with Email/Password
				authForm.classList.add('hidden');
				dashboard.classList.remove('hidden');
				userIdDisplay.textContent = user.uid.substring(0, 12) + '...';
				userEmailDisplay.textContent = user.email;
				statusMessage.textContent = "ACCESS GRANTED";
				statusMessage.style.color = "var(--green)";
			} else if (user && user.isAnonymous) {
				// Signed in Anonymously (Default state)
				authForm.classList.remove('hidden');
				dashboard.classList.add('hidden');
				statusMessage.textContent = "IDENTIFICATION REQUIRED";
				statusMessage.style.color = "var(--cyan)";
			} else {
				// Logged Out
				authForm.classList.remove('hidden');
				dashboard.classList.add('hidden');
				statusMessage.textContent = "SESSION TERMINATED";
				statusMessage.style.color = "var(--danger)";
			}
		}
		
		function showLoading(buttonId, isLoading) {
			const btn = document.getElementById(buttonId);
			const text = document.getElementById(buttonId.replace('Btn', 'Text'));
			const spinner = document.getElementById(buttonId.replace('Btn', 'Spinner'));

			btn.disabled = isLoading;
			if (isLoading) {
				if(text) text.classList.add('hidden');
				if(spinner) spinner.classList.remove('hidden');
			} else {
				if(text) text.classList.remove('hidden');
				if(spinner) spinner.classList.add('hidden');
			}
		}

		function displayError(message) {
			errorBox.textContent = `ERROR: ${message}`;
			errorBox.classList.remove('hidden');
			// Flash effect
			errorBox.style.opacity = '0';
			setTimeout(() => errorBox.style.opacity = '1', 50);
			
			setTimeout(() => {
				errorBox.classList.add('hidden');
			}, 5000);
		}

		// --- Auth Handlers ---

		async function handleLogin() {
			const email = emailInput.value.trim();
			const password = passwordInput.value.trim();
			errorBox.classList.add('hidden');

			if (!email || password.length < 6) {
				displayError("INVALID INPUT PARAMETERS");
				return;
			}

			showLoading('loginBtn', true);
			try {
				await signInWithEmailAndPassword(auth, email, password);
				// Success is handled by onAuthStateChanged
			} catch (error) {
				let errorMessage = "UNKNOWN ERROR";
				if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
					errorMessage = "INVALID CREDENTIALS";
				} else if (error.code) {
					errorMessage = error.message.replace('Firebase: ', '').toUpperCase();
				}
				displayError(errorMessage);
			} finally {
				showLoading('loginBtn', false);
			}
		}

		function handleGetKey() {
			const phoneNumber = "94774337016"; 
			const message = "I require an access key for the Temporal Rift Analyzer";
			const encodedMessage = encodeURIComponent(message);
			const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
			window.open(whatsappUrl, '_blank');
			statusMessage.textContent = "ESTABLISHING COMMS LINK...";
		}

		async function handleLogout() {
			try {
				await signOut(auth);
				emailInput.value = '';
				passwordInput.value = '';
			} catch (error) {
				console.error("Logout Error:", error);
				displayError("LOGOUT FAILURE");
			}
		}

		// --- Event Listeners ---
		loginBtn.addEventListener('click', handleLogin);
		getKeyBtn.addEventListener('click', handleGetKey);
		logoutBtn.addEventListener('click', handleLogout);

		passwordInput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter') {
				handleLogin();
			}
		});

		// --- Init ---
		initializeFirebase();
	</script>
</body>
</html>
